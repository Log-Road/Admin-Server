FROM node:20-alpine AS base

# Install pnpm in base image
RUN npm install -g pnpm

# Create working directory
RUN mkdir -p /app
WORKDIR /app

FROM base AS build

# Copy package files to leverage caching
COPY package.json pnpm-lock.yaml ./

# Install dependencies using pnpm
RUN pnpm install --frozen-lockfile

# Copy the rest of the application code
COPY . .

# Set environment variable
ENV NODE_ENV=prod

# Expose the desired port
EXPOSE 8002

# Command to run the application
CMD [ "node", "main.js" ]
